<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">

    <style>
        body {
            background: #fcfcfc;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="py-5 text-center">
            <h2>Czat w czasie rzeczywistym</h2>
            <p class="lead">Wpisz swoje imiƒô i rozpocznij rozmowƒô</p>
        </div>
        <div class="row">
            <div class="col-6">
                <!-- Formularz do odbierania wiadomo≈õci i nazwa -->
                <h3>Forma wiadomo≈õci</h3>
                <form id="messForm">

                    <br>
                    <label for="message">Wiadomo≈õƒá</label>
                    <textarea name="message" id="message" class="form-control" placeholder="Wpisz wiadomo≈õƒá"></textarea>
                    <br>
                    <input type="submit" value="Wy≈õlij" class="btn btn-danger">


                </form>
                <form action="/logout">
                    <input type="submit" value="Wyloguj siƒô" class="btn btn-danger">
                </form>



            </div>
            <div class="col-6">
                <h3>Wiadomo≈õƒá</h3>
                <!-- Dane wyj≈õciowe wszystkich post√≥w bƒôdƒÖ tutaj -->
                <div id="all_mess"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let currentUser = null; // –≥–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        let socket;
        let allMessages;
        let historyBuffer = []; // –±—É—Ñ–µ—Ä –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

        document.addEventListener('DOMContentLoaded', () => {
            socket = io(); // –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º

            console.log('üì° Socket.IO po≈ÇƒÖczone:', socket);

            // –û—Ç—Ä–∏–º—É—î–º–æ —Å–µ—Å—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            fetch('/session')
                .then(res => {
                    if (!res.ok) throw new Error('B≈ÇƒÖd sesji');
                    return res.json();
                })
                .then(data => {
                    currentUser = data;
                    console.log('Zalogowany jako: ', currentUser.username);
                    maybeRender(); // –í–ò–ü–†–ê–í–õ–ï–ù–û: –≤–∏–∫–ª–∏–∫–∞—î–º–æ —Ä–µ–Ω–¥–µ—Ä –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—ñ—ó
                })
                .catch(err => console.error(err));

            const form = document.getElementById('messForm');
            const messageInput = document.getElementById('message');
            allMessages = document.getElementById('all_mess');

            // –û–±—Ä–æ–±–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const message = messageInput.value.trim();

                if (message && currentUser) {
                    console.log('üì§ Wysy≈Çanie wiadomo≈õci:', { name: currentUser.username, message });
                    socket.emit('chat message', { name: currentUser.username, message });
                    messageInput.value = ''; // –æ—á–∏—â—É—î–º–æ –ø–æ–ª–µ
                }
            });

            // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞
            socket.on('chat history', (messages) => {
                console.log('–æ—Ç—Ä–∏–º–∞–Ω–æ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:', messages);
                historyBuffer = messages;
                maybeRender(); // –í–ò–ü–†–ê–í–õ–ï–ù–û: –≤–∏–∫–ª–∏–∫–∞—î–º–æ —Ä–µ–Ω–¥–µ—Ä –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
            });

            // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —Ä–µ–∂–∏–º—ñ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É
            socket.on('chat message', (data) => {
                const messageElem = createMessageElement(data);
                allMessages.appendChild(messageElem);
            });

            // –û–±—Ä–æ–±–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            socket.on('message deleted', (messageId) => {
                console.log('–æ—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ id:', messageId);

                const messages = document.querySelectorAll('#all_mess .alert');
                messages.forEach(msg => {
                    if (msg.dataset.id === messageId) {
                        msg.remove();
                    }
                });
            });
        });

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä—É —ñ—Å—Ç–æ—Ä—ñ—ó, —è–∫—â–æ —î —ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function maybeRender() {
            if (!currentUser || !historyBuffer.length) return; // –í–ò–ü–†–ê–í–õ–ï–ù–û: —Ä–∞–Ω—ñ—à–µ tryRenderHistory –Ω–µ –≤–∏–∫–æ–Ω—É–≤–∞–≤—Å—è —á–µ—Ä–µ–∑ –ø–æ—Ä—è–¥–æ–∫ –≤–∏–∫–ª–∏–∫—ñ–≤
            allMessages.innerHTML = '';
            historyBuffer.forEach(msg => {
                const messageElem = createMessageElement(msg);
                allMessages.appendChild(messageElem);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function createMessageElement(data) {
            console.log('—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ _id', data._id);

            const div = document.createElement('div');
            div.classList.add('alert', 'alert-secondary', 'mt-2');
            div.innerHTML = `<strong>${data.name}:</strong> ${data.message}`;

            div.dataset.id = data._id;

            // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á - –∞–¥–º—ñ–Ω, –¥–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è
            if (currentUser && currentUser.isAdmin) {
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Usu≈Ñ';
                delBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'ml-2');
                delBtn.style.float = 'right';

                delBtn.onclick = () => {
                    fetch(`/message/${data._id}`, { method: 'DELETE', credentials: 'include' })
                        .then(res => {
                            console.log('–≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ DELETE: ', res.status);
                            if (res.ok) {
                                div.remove();
                            } else {
                                alert('Nie uda≈Ço siƒô usunƒÖƒá wiadomo≈õci');
                            }
                        });
                };
                div.appendChild(delBtn);
            }
            return div;
        }
    </script>

</body>


</html>